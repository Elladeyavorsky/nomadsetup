---
import Layout from '../../layouts/Layout.astro';
import AffiliateBlock from '../../components/AffiliateBlock.astro';
import articlesData from '../../content/articles.json';
import affiliateLinksData from '../../content/affiliate-links.json';
import { marked } from 'marked';

// Helper to escape regex special characters
function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Function to auto-link products in markdown text
function autoLinkProducts(content) {
  let linkedContent = content;
  
  Object.values(affiliateLinksData).forEach(product => {
    // Combine label and keywords associated with the product
    const terms = [product.label, ...(product.keywords || [])];
    
    // Create a Set to remove duplicates and sort by length descending 
    // to match longest phrases first (e.g. "Anker 735" before "Anker")
    const uniqueTerms = [...new Set(terms)].sort((a, b) => b.length - a.length);

    uniqueTerms.forEach(term => {
      if (!term) return;
      
      // Regex to find the term:
      // 1. Not inside a markdown link already (complex to perfect, but we can avoid simple cases)
      // 2. Word boundaries or specific punctuation
      // We use a simplified lookbehind approach or replacement callback to check context if needed.
      // For simplicity in this static site context:
      const regex = new RegExp(`(?<!\\[)${escapeRegExp(term)}(?!\\])(?!\\([^)]+\\))`, 'g');
      
      // Replace with markdown link
      linkedContent = linkedContent.replace(regex, `[${term}](${product.amazonUrl})`);
    });
  });
  
  return linkedContent;
}

export async function getStaticPaths() {
  return articlesData.map(article => ({
    params: { section: article.section, slug: article.slug },
    props: { article }
  }));
}

const { article } = Astro.props;

// Detect products mentioned in the content
const mentionedProductIds = Object.entries(affiliateLinksData)
    .filter(([id, product]) => {
        const terms = [product.label, ...(product.keywords || [])];
        return terms.some(term => term && article.content.toLowerCase().includes(term.toLowerCase()));
    })
    .map(([id]) => id);

// Merge explicit featured products with auto-detected ones (and remove duplicates)
const finalProductIds = [...new Set([...article.featuredAffiliateProductIds, ...mentionedProductIds])];

// Auto-link the content before parsing markdown
const linkedMarkdown = autoLinkProducts(article.content);
const contentHtml = marked.parse(linkedMarkdown);

// Get related articles (same section, exclude current)
const relatedArticles = articlesData
    .filter(a => a.section === article.section && a.id !== article.id)
    .slice(0, 3);
---

<Layout title={article.title} description={article.excerpt}>
  <article class="article-content">
    <header>
        <div class="meta text-sm">
            <div class="author-signature">
                {article.authorName === "Ella D." && <img src="/authors/ella.jpg" alt="Ella D." class="author-img" />}
                {article.authorName === "Gautier D." && <img src="/authors/gautier.png" alt="Gautier D." class="author-img" />}
                <span>Par {article.authorName}</span>
            </div>
            <span class="separator">•</span>
            <a href={`/${article.section}`}>{article.section}</a> • <time>{article.publishedDate}</time>
        </div>
        <h1>{article.title}</h1>
        <p class="lead">{article.excerpt}</p>
    </header>
    
    <div class="content" set:html={contentHtml} />
    
    {finalProductIds.length > 0 && (
        <div class="affiliate-section">
            <h3>Produits recommandés dans cet article</h3>
            <p class="disclaimer text-sm">
                Transparence : cet article contient des liens affiliés. Cela soutient notre travail sans surcoût pour vous.
            </p>
            {finalProductIds.map(id => (
                <AffiliateBlock productId={id} />
            ))}
        </div>
    )}
  </article>

  {relatedArticles.length > 0 && (
      <section class="related-section">
          <h3>Lire aussi</h3>
          <ul class="related-list">
              {relatedArticles.map(a => (
                  <li><a href={`/${a.section}/${a.slug}`}>{a.title}</a></li>
              ))}
          </ul>
      </section>
  )}
</Layout>

<style>
    .article-content {
        max-width: 65ch;
        margin: 0 auto;
    }
    .lead {
        font-size: 1.2rem;
        color: var(--color-text-light);
        margin: 1.5rem 0 3rem;
    }
    .meta {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 2rem;
    }
    .author-signature {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        color: var(--color-accent);
    }
    .author-img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--color-border);
    }
    .separator {
        color: var(--color-border);
    }
    .meta a {
        text-transform: uppercase;
        color: var(--color-text-light);
    }
    .affiliate-section {
        margin-top: 4rem;
        padding-top: 2rem;
        border-top: 1px solid var(--color-border);
    }
    .disclaimer {
        font-style: italic;
        margin-bottom: 2rem;
    }
    .related-section {
        margin-top: 4rem;
        padding-top: 2rem;
        border-top: 1px solid var(--color-border);
        max-width: 65ch;
        margin-left: auto;
        margin-right: auto;
    }
    /* Simple markdown styles */
    .content :global(h2) { margin-top: 2em; }
    .content :global(ul) { padding-left: 1.2em; }
</style>
