---
import Layout from '../../layouts/Layout.astro';
import ProductCard from '../../components/ProductCard.astro';
import articlesData from '../../content/articles.json';
import affiliateLinksData from '../../content/affiliate-links.json';
import { marked } from 'marked';

// Helper to escape regex special characters
function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Function to auto-link products in markdown text
function autoLinkProducts(content) {
  let linkedContent = content;
  
  Object.values(affiliateLinksData).forEach(product => {
    const terms = [product.label, ...(product.keywords || [])];
    const uniqueTerms = [...new Set(terms)].sort((a, b) => b.length - a.length);

    uniqueTerms.forEach(term => {
      if (!term) return;
      const regex = new RegExp(`(?<!\\[)${escapeRegExp(term)}(?!\\])(?!\\([^)]+\\))`, 'g');
      linkedContent = linkedContent.replace(regex, `[${term}](${product.amazonUrl})`);
    });
  });
  
  return linkedContent;
}

export async function getStaticPaths() {
  return articlesData.map(article => ({
    params: { section: article.section, slug: article.slug },
    props: { article }
  }));
}

const { article } = Astro.props;

// Split content to separate "Produits mentionnés" section
const produitsRegex = /## Produits mentionnés[\s\S]*$/;
const contentWithoutProduits = article.content.replace(produitsRegex, '').trim();

// Auto-link the content before parsing markdown (excluding Produits mentionnés)
const linkedMarkdown = autoLinkProducts(contentWithoutProduits);
const contentHtml = marked.parse(linkedMarkdown);

// Get related articles (same section, exclude current)
const relatedArticles = articlesData
    .filter(a => a.section === article.section && a.id !== article.id)
    .slice(0, 3);

const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---

<Layout title={article.title} description={article.excerpt}>
  <article class="article-content">
    <header>
        <div class="meta text-sm">
            <div class="author-signature">
                {article.authorName === "Ella D." && <img src={`${base}/authors/ella.jpg`} alt="Ella D." class="author-img" />}
                {article.authorName === "Gautier D." && <img src={`${base}/authors/gautier.png`} alt="Gautier D." class="author-img" />}
                <span>Par {article.authorName}</span>
            </div>
            <span class="separator">•</span>
            <a href={`${base}/${article.section}`}>{article.section}</a> • <time>{article.publishedDate}</time>
        </div>
        <h1>{article.title}</h1>
        <p class="lead">{article.excerpt}</p>
    </header>
    
    <div class="content" set:html={contentHtml} />
  </article>

  {article.featuredAffiliateProductIds && article.featuredAffiliateProductIds.length > 0 && (
    <section class="products-section">
      <h2 class="section-title">Produits mentionnés</h2>
      <div class="products-grid">
        {article.featuredAffiliateProductIds.map(productId => (
          <ProductCard productId={productId} />
        ))}
      </div>
    </section>
  )}

  {relatedArticles.length > 0 && (
      <section class="related-section">
          <h2 class="section-title">Articles recommandés</h2>
          <ul class="related-list">
              {relatedArticles.map(a => (
                  <li>
                    <a href={`${base}/${a.section}/${a.slug}`}>
                      <span class="article-category">{a.section}</span>
                      <span class="article-title-link">{a.title}</span>
                    </a>
                  </li>
              ))}
          </ul>
      </section>
  )}

</Layout>

<style>
    .article-content {
        max-width: 65ch;
        margin: 0 auto;
    }
    .lead {
        font-size: 1.2rem;
        color: var(--color-text-light);
        margin: 1.5rem 0 3rem;
    }
    .meta {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 2rem;
    }
    .author-signature {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        color: var(--color-accent);
    }
    .author-img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--color-border);
    }
    .separator {
        color: var(--color-border);
    }
    .meta a {
        text-transform: uppercase;
        color: var(--color-text-light);
    }
    .products-section {
        margin-top: 4rem;
        padding-top: 3rem;
        border-top: 1px solid var(--color-border);
    }
    .products-grid {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-top: 2rem;
    }
    .related-section {
        margin-top: 5rem;
        padding-top: 3rem;
        border-top: 1px solid var(--color-border);
        max-width: 65ch;
        margin-left: auto;
        margin-right: auto;
    }
    .section-title {
        font-size: 1.5rem;
        margin-bottom: 2rem;
        color: var(--color-text);
    }
    .related-list {
        list-style: none;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    .related-list li a {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        text-decoration: none;
        padding: 1rem;
        border-radius: 8px;
        background: #fcfcfc;
        border: 1px solid var(--color-border);
        transition: all 0.2s ease;
    }
    .related-list li a:hover {
        background: #fff;
        transform: translateX(4px);
        border-color: var(--color-accent);
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }
    .article-category {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--color-text-light);
        font-weight: 600;
    }
    .article-title-link {
        font-size: 1.1rem;
        font-weight: 500;
        color: var(--color-text);
    }
    /* Simple markdown styles */
    .content :global(h2) { margin-top: 2em; }
    .content :global(ul) { padding-left: 1.2em; }
</style>

